{% extends 'base.html' %}

{% block content %}
<!-- Appointment Reminder Card -->
<div class="max-w-2xl mx-auto bg-white border border-pink-300 rounded-2xl shadow-[0_4px_30px_rgba(255,182,193,0.4)] p-8 mt-10">
  <h2 class="text-3xl font-bold text-pink-600 mb-6 text-center">üìÖ Appointment Reminder</h2>

  <div class="space-y-5">
    <div>
      <label class="block mb-1 font-medium">Select Language:</label>
      <select id="language" class="w-full px-4 py-3 border border-pink-300 rounded-xl focus:ring focus:ring-pink-200">
        <option>English</option>
        <option>Hindi</option>
        <option>Kannada</option>
      </select>
    </div>
    <div>
      <label class="block mb-1 font-medium">Hospital Name:</label>
      <input type="text" id="hospitalInput" placeholder="e.g., City Hospital"
        class="w-full px-4 py-3 border border-pink-300 rounded-xl focus:ring focus:ring-pink-200">
    </div>

    <div>
      <label class="block mb-1 font-medium">Doctor's Name:</label>
      <input type="text" id="doctorInput" placeholder="e.g., Dr. Smith"
        class="w-full px-4 py-3 border border-pink-300 rounded-xl focus:ring focus:ring-pink-200">
    </div>
    <div>
      <label class="block mb-1 font-medium">Set Appointment Date:</label>
      <input type="date" id="dateInput" class="w-full px-4 py-3 border border-pink-300 rounded-xl focus:ring focus:ring-pink-200">
    </div>

    <div>
      <label class="block mb-1 font-medium">Set Appointment Time (HH:MM 24-hour):</label>
      <input type="time" id="timeInput" class="w-full px-4 py-3 border border-pink-300 rounded-xl focus:ring focus:ring-pink-200">
    </div>

    <div class="flex justify-center gap-4">
      <button id="setManualBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 
         text-white font-semibold px-8 py-3 
         rounded-full shadow-lg 
         hover:from-pink-500 hover:to-purple-500 
         transform hover:scale-105 transition duration-300 ease-in-out">Set Manual Appointment</button>
    </div>

    <div class="flex justify-center">
      <button id="exportBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">üì• Export CSV</button>
    </div>

    <p id="status" class="font-medium text-sm text-gray-700 text-center">Status: Waiting...</p>
  </div>
</div>

<!-- Appointment History -->
<div class="max-w-2xl mx-auto bg-white border border-gray-200 rounded-xl shadow p-6 mt-8">
  <h2 class="text-lg font-bold mb-2 text-gray-800">üóÇÔ∏è Appointment History</h2>
  <div id="historyTable" class="space-y-2"></div>
</div>

<!-- FullCalendar -->
<div id="calendar" class="max-w-4xl mx-auto mt-8"></div>

<!-- Scripts -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

<script>
  const languageSelect = document.getElementById('language');
  const hospitalInput = document.getElementById('hospitalInput');
  const doctorInput = document.getElementById('doctorInput');
  const dateInput = document.getElementById('dateInput');
  const timeInput = document.getElementById('timeInput');
  const status = document.getElementById('status');
  const historyTable = document.getElementById('historyTable');
  const exportBtn = document.getElementById('exportBtn');

  let reminders = [];
  let historyRecords = [];
  let calendar;
  let eventTimes = {}; // date -> [times]

  const texts = {
    "English": "You have an upcoming appointment. Please confirm: Will you attend?",
    "Hindi": "‡§Ü‡§™‡§ï‡•Ä ‡§è‡§ï ‡§®‡§ø‡§Ø‡•ã‡§ú‡§ø‡§§ ‡§Ö‡§™‡•â‡§á‡§Ç‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç: ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Ü‡§è‡§Ç‡§ó‡•á?",
    "Kannada": "‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤¨‡≤≥‡≤ø ‡≤Æ‡≥Å‡≤Ç‡≤¶‡≤ø‡≤® ‡≤≠‡≥á‡≤ü‡≤ø‡≤Ø‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤¶‡≥É‡≤¢‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø: ‡≤®‡≥Ä‡≤µ‡≥Å ‡≤¨‡≤∞‡≥Å‡≤µ‡≤ø‡≤∞‡≤æ?"
  };

  document.getElementById('setManualBtn').onclick = () => {
  const date = dateInput.value;
  const time = timeInput.value;
  const language = languageSelect.value;
  const hospital = hospitalInput.value.trim();
  const doctor = doctorInput.value.trim();

    if (!date || !time || !hospital || !doctor) {
      Swal.fire('Please fill out all fields (date, time, hospital, doctor)');
      return;
    }

   
    status.textContent = `üìÖ Appointment set for ${date} at ${time} at ${hospital} with ${doctor}`;

 
  fetch('/add_appointment', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ date: date, time: time, language: language })
  })
  .then(response => response.json())
  .then(data => {
    Swal.fire('Success', data.message || 'Appointment saved!', 'success');
  })
  


  const dateTime = `${date} ${time}`;
  reminders.push(dateTime);
  addEventToCalendar(date, time);

  Swal.fire('Appointment Set!', `Scheduled for ${date} at ${time}`, 'success');
};


  exportBtn.onclick = () => {
    if (historyRecords.length === 0) {
      return Swal.fire('No records to export');
    }

    const csvContent = "data:text/csv;charset=utf-8," +
      ["Date,Time,Language,Status"].join(",") + "\n" +
      historyRecords.map(r => `${r.date},${r.time},${r.language},${r.status}`).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "appointment_history.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  function playReminder(lang) {
    return new Promise(resolve => {
      const utter = new SpeechSynthesisUtterance(texts[lang]);
      utter.lang = { English: 'en-US', Hindi: 'hi-IN', Kannada: 'kn-IN' }[lang];
      utter.onend = () => resolve();
      speechSynthesis.speak(utter);
    });
  }

  async function handleReminderFlow(lang) {
    await playReminder(lang);
    await new Promise(r => setTimeout(r, 1000));
    showConfirmationPopup(lang);
  }

  function showConfirmationPopup(lang) {
    Swal.fire({
      title: 'üìÖ Appointment Reminder',
      text: 'Will you attend your appointment?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: '‚úÖ Yes',
      cancelButtonText: '‚ùå No'
    }).then(result => {
      const statusText = result.isConfirmed ? 'Attending' : 'Not Attending';
      status.innerHTML = result.isConfirmed
        ? '<span class="text-green-600 font-bold">‚úÖ Attending</span>'
        : '<span class="text-red-600 font-bold">‚ùå Not Attending</span>';
      updateHistory(lang, statusText);
      Swal.fire(statusText, `Appointment ${statusText}`, result.isConfirmed ? 'success' : 'info');
    });
  }

  function updateHistory(lang, result) {
    const now = new Date();
    const date = now.toLocaleDateString();
    const time = now.toLocaleTimeString().slice(0, 5);

    historyRecords.push({
      date,
      time,
      language: lang,
      status: result
    });

    const entry = document.createElement('div');
    entry.className = `flex justify-between items-center border px-4 py-2 rounded-lg ${result === 'Attending' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
    entry.innerHTML = `<div>${date} ${time} [${lang}]</div><div class="text-xl font-bold">${result === 'Attending' ? '‚úÖ' : '‚ùå'}</div>`;
    historyTable.prepend(entry);
  }

  function checkReminderLoop() {
    setInterval(() => {
      const now = new Date();
      const yyyy_mm_dd = now.toISOString().slice(0, 10);
      const hhmm = now.toTimeString().slice(0, 5);
      const current = `${yyyy_mm_dd} ${hhmm}`;
      if (reminders.includes(current)) {
        const lang = languageSelect.value;
        handleReminderFlow(lang);
        reminders = reminders.filter(r => r !== current);
      }
    }, 10000);
  }

  function addEventToCalendar(date, time) {
    const [yyyy, mm, dd] = date.split('-');
    const [h, m] = time.split(':');
    const eventTime = new Date(yyyy, mm - 1, dd, h, m);
    const dateKey = eventTime.toDateString();

    if (!eventTimes[dateKey]) eventTimes[dateKey] = [];
    eventTimes[dateKey].push(time);

    calendar.addEvent({
      title: 'üìå Appointment',
      start: eventTime,
      allDay: false
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 500,
      headerToolbar: {
        left: 'title',
        right: 'prev,next today'
      },
      dateClick: function(info) {
        const clickedDate = new Date(info.dateStr);
        const dateKey = clickedDate.toDateString();
        const times = eventTimes[dateKey] || [];
        if (times.length > 0) {
          Swal.fire('Appointments on ' + info.dateStr, times.join(', '), 'info');
        } else {
          Swal.fire('No Appointments', 'You have no appointments on this date.', 'info');
        }
      }
    });
    calendar.render();
  })

  checkReminderLoop();
</script>
{% endblock %}
